#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>

#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define MSG_LEN 64
typedef struct {
    char msg[64];
} Package;

char *gets(char *c);

void showHelp() {
    puts("---------------------------------------------");
    puts("  create.........make new package");
    puts("  read...........read existing package");
    puts("  help...........show this page");
    puts("  exit...........quit program");
    puts("---------------------------------------------");
}

int main(int argc, char **argv) {
    char c[16];
    Package p[5];
    showHelp();

    while (true) {
        printf("> ");
        gets(c);
        c[strcspn(c, "\n")] = 0;

        if (strcmp(c, "create") == 0) {
            int i = -1;
            puts("Enter Index: ");
            if (scanf("%d", &i) != 1) exit(0);
            getchar(); // Remove trailing \n

            // ensure we do not index outside range of array
            if (i < 0 && i > 4) {
                puts("Index is outside bounds of Arr!");
                continue;
            }

            printf("Package Address: %p\n", &(p[i].msg) );
            printf("Package Message > ");
            fgets(p[i].msg, MSG_LEN, stdin);
        } else if (strcmp(c, "read") == 0) {
            int i = -1;
            puts("Enter Index: ");
            if (scanf("%d", &i) != 1) exit(0);
            getchar(); // Remove trailing \n

            // ensure we do not index outside range of array
            if (i < 0 && i > 4) {
                puts("Index is outside bounds of Arr!");
                continue;
            }
            printf("Package Message > %s\n", p[i].msg);
        } else if (strcmp(c, "exit") == 0) {
            break;
        } else if (strcmp(c, "help") == 0) {
            showHelp();
        } else {
            break;
        }
    }

    return 0;
}
// COMPILE: gcc vuln.c -o vuln -fno-stack-protector -no-pie -z execstack
