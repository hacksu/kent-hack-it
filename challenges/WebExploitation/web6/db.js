import sqlite3 from "sqlite3";
import crypto from 'crypto';

const db = new sqlite3.Database('database.db');

function InitializeDatabase() {
    // Create a table if it doesn't exist | inserts our dummy data
    db.run(`
        CREATE TABLE IF NOT EXISTS users (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          username TEXT,
          email TEXT,
          password TEXT
        )
    `, (err) => {
        if (err) {
            console.error('Error creating users table', err.message);
            return;
        }
    
        // Now that the table is created, insert admin user
        const username = 'admin';
        const email = 'admin@hacksu.com';
        const password = '0*k;8NSJ2J[G1$CG)@>!($#:';
        const hashedPassword = crypto.createHash('sha256').update(password).digest('hex');
    
        db.get(`SELECT * FROM users WHERE username = "${username}"`, (err, user) => {
            if (err) {
                console.error('Error querying users', err.message);
                return;
            }
    
            if (!user) {
                // No user found, insert new one
                db.run(`
                    INSERT INTO users (username, email, password)
                    VALUES ("${username}", "${email}", "${hashedPassword}")
                `, (err) => {
                    if (err) {
                        console.error('Error inserting user', err.message);
                    } else {
                        console.log('Default admin user created');
                    }
                });
            } else {
                console.log('Admin user already exists');
            }
        });
    });

    // put flag in db
    db.run(`
        CREATE TABLE IF NOT EXISTS secrets (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          flag TEXT
        )
    `, (err) => {
        if (err) {
            console.error('Error creating secrets table', err.message);
            return;
        }
    
        // Now that the table is created, insert admin user
        const flag = 'KHI{fake_flag}';
    
        db.get('SELECT * FROM secrets WHERE flag = "KHI{fake_flag}"', (err, user) => {
            if (err) {
                console.error('Error querying secrets', err.message);
                return;
            }
    
            if (!user) {
                // No secrets found, insert new one
                db.run(`
                    INSERT INTO secrets (flag)
                    VALUES ("${flag}")
                `, (err) => {
                    if (err) {
                        console.error('Error inserting secrets', err.message);
                    } else {
                        console.log('Flag has been pushed into DB');
                    }
                });
            } else {
                console.log('Flag already exists');
            }
        });
    });
    
    // Create a table if it doesn't exist
    db.serialize(() => {
        db.run(`
            CREATE TABLE IF NOT EXISTS employees (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            position TEXT NOT NULL,
            office TEXT NOT NULL,
            age INTEGER NOT NULL,
            start_date TEXT NOT NULL,
            salary TEXT NOT NULL
            )
        `, (err) => {
            if (err) {
                console.error('Error creating employees table', err.message);
                return;
            }

            // Sample data to insert into the table
            const sampleData = [
                { name: 'John Doe', position: 'Software Engineer', office: 'New York', age: 29, start_date: '2015-01-12', salary: '$120,000' },
                { name: 'Jane Smith', position: 'Marketing Manager', office: 'London', age: 34, start_date: '2016-03-25', salary: '$90,000' },
                { name: 'Jim Brown', position: 'Product Designer', office: 'Sydney', age: 42, start_date: '2017-09-15', salary: '$100,000' },
                { name: 'Lucy Green', position: 'HR Manager', office: 'San Francisco', age: 28, start_date: '2018-11-23', salary: '$80,000' },
                { name: 'Mike White', position: 'UX/UI Developer', office: 'Tokyo', age: 36, start_date: '2019-02-14', salary: '$110,000' }
            ];

            db.get('SELECT * FROM employees WHERE name = "John Doe"', (err, user) => {
                if (err) {
                    console.error('Error querying employees', err.message);
                    return;
                }
        
                if (!user) {
                    // Insert sample data into the table
                    const stmt = db.prepare(`
                        INSERT INTO employees (name, position, office, age, start_date, salary)
                        VALUES (?, ?, ?, ?, ?, ?)
                    `);
                
                    sampleData.forEach((user) => {
                        stmt.run(user.name, user.position, user.office, user.age, user.start_date, user.salary);
                    });
                
                    console.log("Employees Table Initialized!");
                    stmt.finalize();
                } else {
                    console.log("Employees Table contains entries");
                }
            });
        });
    });
}

function GetDatabase() { return db; }

export { InitializeDatabase, GetDatabase }