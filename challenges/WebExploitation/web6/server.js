// ES Format Inclusions
import { fileURLToPath } from "url";
import express from "express";
import session from "express-session";
import sqlite3 from "sqlite3";
import crypto from 'crypto';
import path from "path";

import { InitializeDatabase, GetDatabase } from "./db.js"

const app = express();
const port = 4444; // change to desired port

// set up db
InitializeDatabase();
const db = GetDatabase();

// handle JSON and urlencode post reqs
app.use(express.json());
app.use(express.urlencoded({ extended: true }));


// Set up the session middleware
const secretKey = crypto.randomBytes(32).toString('hex');
app.use(session({
    secret: secretKey, // Secret key for encrypting the session
    resave: false,             // Don't save session if it's not modified
    saveUninitialized: false,  // Don't create a session until something is stored
    cookie: { secure: false }  // Set to `true` if using HTTPS
  }));

// Get the correct directory of the current script
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, "index.html"));
});

app.post('/', (req, res) => {
    try {
        const email = req.body.email;
        const password = req.body.password;
        const hashedPassword = crypto.createHash('sha256').update(password).digest('hex');
    
        console.log(`FORM >> ${email}:${password}`);
    
        const query = `SELECT * FROM users WHERE username = "${email}" and password = "${hashedPassword}"`;
        console.log("Attempting Query. . .");
        console.log(query);
    
        db.get(query, [], (err, user) => {
            if (err) {
                console.error(err.message);
                return res.status(500).json({ message: 'Database error' });
            }
    
            if (!user) {
                console.error("Bad Credential");
                return res.status(401).json({ message: 'Invalid email or password' });
            }
    
            // Success
            console.log("Good Credential");
            req.session.user = user;
            res.status(200).json({ message: 'Login successful', user: { id: user.id, username: user.username } });
        });
    } catch (err) {
        console.error("Malformed Form Received!", err);
        return res.status(500).json({ message: 'Server error' });
    }
});

app.get('/dashboard', (req, res) => {
    if (req.session.user) {
        // Accessing user info from the session
        res.sendFile(path.join(__dirname, "dashboard.html"));
    } else {
        return res.status(401).send('<h3>Not Authenticated!</h3><a href="/">Back to Login. . .</a>');
    }
});

app.post('/api/employees', (req, res) => {
    const name = req.body.name;
    if (name !== "") {
        const q = `SELECT * FROM employees WHERE name like "%${name}%"`
        console.log(`ADMIN QUERY >> ${q}`)
        db.all(q, [], (err, rows) => {
            if (err) {
                console.error('Error querying employees', err.message);
                res.status(500).send('Database error');
                return;
            }
            console.log(rows);
            res.json(rows);
        });
    } else {
        console.log("ADMIN DEFAULT QUERY")
        db.all("SELECT * FROM employees", [], (err, rows) => {
            if (err) {
                console.error('Error querying employees', err.message);
                res.status(500).send('Database error');
                return;
            }
            res.json(rows);
        });
    }
});

// listen on all interfaces for networking reasons
app.listen(port, '0.0.0.0', () => {
    console.log(`Site running on http://0.0.0.0:${port}`);
});