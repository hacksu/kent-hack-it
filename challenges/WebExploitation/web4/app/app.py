from flask import Flask, render_template, render_template_string, request, send_from_directory, Response
from os import urandom

PORT=4444
app = Flask(__name__)
app.secret_key = urandom(32)

blog_posts_db = {
    'jack': {
        'title': 'Jack the German Shepard',
        'image_url': '/images/jack.png',
        'content': 'Jack is a strong and loyal German Shepard. He loves playing fetch and going on long walks.',
        'excerpt': 'Jack is a loyal German Shepard...',
        'url': '/blog?id=jack',
    },
    'rufus': {
        'title': 'Furry Play-mate Rufus',
        'image_url': '/images/rufus.png',
        'content': 'Rufus is a playful and energetic dog. He enjoys playing with other dogs and running in the park.',
        'excerpt': 'Rufus is a playful furry friend...',
        'url': '/blog?id=rufus',
    },
    'bella': {
        'title': 'Bella the Border Collie',
        'image_url': '/images/bella.png',
        'content': 'Bella is an intelligent Border Collie. She excels at agility courses and loves her daily training sessions.',
        'excerpt': 'Bella is an intelligent dog...',
        'url': '/blog?id=bella',
    },
    'hawkeye': {
        'title': 'Hawkeye',
        'image_url': '/images/hawkeye.png',
        'content': 'Hawkeye is an adventurous chicken who enjoys being in high places.',
        'excerpt': 'Looks like a Hawk...',
        'url': '/blog?id=hawkeye',
    },
    'lucy': {
        'title': 'Lucy the Labrador',
        'image_url': '/images/lucy.png',
        'content': 'Lucy is a friendly Labrador who loves to swim and retrieve. She is the perfect companion for outdoor adventures.',
        'excerpt': 'Lucy is a loyal and friendly dog...',
        'url': '/blog?id=lucy',
    },
    'max': {
        'title': 'Max the Bulldog',
        'image_url': '/images/max.png',
        'content': 'Max is a laid-back Bulldog who loves lounging around and chewing on his favorite toys.',
        'excerpt': 'Max enjoys a relaxed lifestyle...',
        'url': '/blog?id=max',
    },
    'charlie': {
        'title': 'Charlie the Beagle',
        'image_url': '/images/charlie.png',
        'content': 'Charlie is a curious Beagle who loves to explore and follow scents. He is always eager for a good hike.',
        'excerpt': 'Charlie is a curious and energetic dog...',
        'url': '/blog?id=charlie',
    },
    'daisy': {
        'title': 'Daisy the Dalmatian',
        'image_url': '/images/daisy.png',
        'content': 'Daisy is a playful Dalmatian with a lot of energy. She enjoys running and playing with other dogs.',
        'excerpt': 'Daisy loves to play and run...',
        'url': '/blog?id=daisy',
    },
    'randy': {
        'title': 'Randy of the Orange',
        'image_url': '/images/randy.png',
        'content': 'Randy is a frivolous feline who likes being mischevious in the kitchen.',
        'excerpt': 'The will of Orange...',
        'url': '/blog?id=randy',
    },
    'buddy': {
        'title': 'Buddy the Golden Retriever',
        'image_url': '/images/buddy.png',
        'content': 'Buddy is a gentle Golden Retriever who loves playing fetch and swimming in the lake.',
        'excerpt': 'Buddy is a friendly and loyal dog...',
        'url': '/blog?id=buddy',
    },
    'rocky': {
        'title': 'Rocky the Rottweiler',
        'image_url': '/images/rocky.png',
        'content': 'Rocky is a strong and protective Rottweiler who loves spending time with his family and keeping them safe.',
        'excerpt': 'Rocky is a loyal and protective dog...',
        'url': '/blog?id=rocky',
    },
    'sasha': {
        'title': 'Sasha the Siberian Husky',
        'image_url': '/images/sasha.png',
        'content': 'Sasha is an adventurous Siberian Husky who enjoys long hikes in the snow and pulling sleds.',
        'excerpt': 'Sasha is a wild spirit...',
        'url': '/blog?id=sasha',
    }
}

@app.route('/images/<filename>')
def get_image(filename):
    return send_from_directory("images", filename)

@app.route("/robots.txt")
def robots():
    return Response("User-agent: *\nDisallow: /", mimetype="text/plain")

@app.route('/', methods=['GET', 'POST'])
def home():
    if request.method == "POST":
        # introduce SSTI from flask render_template_string
        search_id = request.form.get('id')
        # print(f"User Searching --> {search_id}")
        
        # Use render_template_string to allow dynamic template evaluation
        with open('templates/index_ssti.html') as f:
            template_content = f.read()
        template_content=template_content.replace("RESULTS", f"<b> Results for: </b>{search_id}")
        return render_template_string(template_content, search_id=search_id, blog_posts=blog_posts_db)

    return render_template('index.html', blog_posts=blog_posts_db)

@app.route('/blog', methods=['GET'])
def blog():
    post_id = request.args.get('id')
    post = blog_posts_db.get(post_id)
    
    if not post:
        return render_template('404.html'), 404

    return render_template('blog.html', post=post)

def main():
    # debug=True is dangerous to have in the public internet
    # for development the service restarts when changes are
    # made in real-time
    app.run(debug=False, host="0.0.0.0", port=PORT)

if __name__ == '__main__':
    main()