// index.js
const express = require("express");
const Database = require("better-sqlite3");

const fs = require("fs");
const path = require("path");

const app = express();
const PORT = 3000;

FLAG = process.env.FLAG || "ERROR | ALERT ADMINS ABOUT MISSING FLAG!"

// Middleware to handle JSON and urlencoded
// application content-types in POST Requests
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Open (or create) database
const db = new Database("./bank.sqlite");
// enforce foreign keys
db.pragma("foreign_keys = ON");

// Create tables if none exist
db.prepare(`
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT,
            password TEXT
            )
        `).run();

db.prepare(`
        CREATE TABLE IF NOT EXISTS accounts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT,
            email TEXT,
            routing INTEGER,
            checking INTEGER,
            saving INTEGER,
            off_shore TEXT,
            uid INTEGER UNIQUE,
            FOREIGN KEY (uid) REFERENCES users(id)
            )
        `).run();

function randomUsername(id) {
    return `user${id}_${Math.random().toString(36).substring(2, 6)}`;
}
function randomPassword() {
    return Math.random().toString(36).substring(2, 12);
}
function randomEmail(id) {
    return `user${id}_${Math.random().toString(36).substring(2, 4)}@mail.com`;
}
function randomRouting() {
    return Math.floor(100000000 + Math.random() * 900000000); // 9-digit
}
function randomChecking() {
    return (Math.random() * 5000 + 500).toFixed(2); // 500–5500
}
function randomSaving() {
    return (Math.random() * 10000 + 1000).toFixed(2); // 1000–11000
}

// Prepopulate users 0–3
for (let i = 0; i <= 3; i++) {
    const username = randomUsername(i);
    const password = randomPassword();
    const email = randomEmail(i);
    const routing = randomRouting();
    const checking = randomChecking();
    const saving = randomSaving();
    const offShore = randomRouting();

    // Insert user with specific id
    db.prepare(`
        INSERT OR IGNORE INTO users (id, username, password) VALUES (?, ?, ?)
    `).run(i, username, password);

    // Insert account tied to that uid
    db.prepare(`
        INSERT OR IGNORE INTO accounts (name, email, routing, checking, saving, off_shore, uid)
        VALUES (?, ?, ?, ?, ?, ?, ?)
    `).run(username, email, routing, checking, saving, offShore, i);
}

// prepopulate db with flag holder
db.prepare(`
    INSERT OR IGNORE INTO users (id, username, password) VALUES (4, 'alfresc0', 'I&TF^&2gRI_+')
`).run();
db.prepare(`
  INSERT OR IGNORE INTO accounts (name, email, routing, checking, saving, off_shore, uid)
  VALUES ('Alfresco', 'alfres@hotmail.com', 123456789, 142, 5255, '${FLAG}', 4)
`).run();

// Reset the auto increment counter back to 0 
// so new inserts start at 1 again
db.prepare("DELETE FROM sqlite_sequence WHERE name='users'").run();
db.prepare("DELETE FROM sqlite_sequence WHERE name='accounts'").run();

//##########################################

// uses session id to reroute to /dashboard?id=10
app.get("/dashboard", (req,res) => {
    // pull the id parameter from the URL
    const id = req.query.id;
    let page = fs.readFileSync(path.join(__dirname, "dashboard.html"), "utf8");

    if (id) {
        const data = db.prepare("SELECT * FROM accounts WHERE uid = ?").get(id);

        if (data) {
            page = page.replace('{acc_name}', data.name)
            page = page.replace('{checking}', data.checking)
            page = page.replace('{savings}', data.saving)
            page = page.replace('{routing}', data.routing)
            page = page.replace('{shore}', data.off_shore)

            res.send(page)
        } else {
            res.status(500).send("Server Error")
        }
    } else {
        res.status(500).send("Server Error")
    }
})

app.post("/login", (req, res) => {
    try {
        const { username, password } = req.body;
        if (username && password) {
            // attempt to login
            const user = db.prepare(`
                SELECT * FROM users WHERE username = ? AND password = ?
                `).get(username, password);

            if (user) {
                res.send('Authorized');
            } else {
                res.status(401).send("Unauthorized");
            }
        } else {
            res.status(401).send("Unauthorized")
        }
    } catch (err) {
        res.status(500).send("Server Error")
    }
})
app.get("/login", (req, res) => {
    let page = fs.readFileSync(path.join(__dirname, "login.html"), "utf8");
    res.send(page)
})

app.post("/register", (req, res) => {
    try {
        const { name, username, password, email } = req.body;

        if (!name || !username || !password || !email) {
            return res.status(400).send("Missing required fields");
        }

        // Check if username already exists
        const existing = db.prepare("SELECT * FROM users WHERE username = ?").get(username);
        if (existing) {
            return res.status(409).send("Username already taken");
        }

        // Insert into DB
        const stmt = db.prepare("INSERT INTO users (username, password) VALUES (?, ?)");
        const info = stmt.run(username, password);

        const accStmt = db.prepare(`
            INSERT INTO accounts (name, email, routing, checking, saving, off_shore, uid)
            VALUES (?, ?, ?, ?, ?, '', ?)
        `);
        
        const routing = Math.floor(100000000 + Math.random() * 900000000); // 9-digit routing number
        const checking = (Math.random() * 5000 + 500).toFixed(2); // $500 - $5500    
        const savings = (Math.random() * 10000 + 1000).toFixed(2); // $1000 - $11000
        const uid = info.lastInsertRowid
        
        const accInfo = accStmt.run(name, email, routing, checking, savings, uid);

        res.status(201).redirect(`/dashboard?id=${uid}`);
    } catch (err) {
        console.error(err);
        res.status(500).send("Server error");
    }
})
app.get("/register", (req, res) => {
    let page = fs.readFileSync(path.join(__dirname, "register.html"), "utf8");
    res.send(page)
})

app.get('/logout', (req, res) => {
    res.redirect('/'); 
})

//##########################################

app.get("/", (req, res) => {
    let page = fs.readFileSync(path.join(__dirname, "index.html"), "utf8");
    res.send(page)
})

app.listen(PORT, () => {
    console.log(`Server running at http://localhost:${PORT}`);
});
