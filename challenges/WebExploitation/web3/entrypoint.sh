#!/bin/bash

# handle installing geckodriver
function install_gecko {
    # get arch type
    ARCH="$(uname -m)"
    GECKO_URL=""

    # get correct download url
    if [ $ARCH == "x86_64" ]; then
        GECKO_URL="https://github.com/mozilla/geckodriver/releases/download/v0.36.0/geckodriver-v0.36.0-linux64.tar.gz"
    fi

    if [ $ARCH == "aarch64" ]; then
        GECKO_URL="https://github.com/mozilla/geckodriver/releases/download/v0.36.0/geckodriver-v0.36.0-linux-aarch64.tar.gz"
    fi

    # download the geckodrvier and move it into PATH
    curl -kL $GECKO_URL -o /tmp/geckodriver.tar.gz && \
    tar -xf /tmp/geckodriver.tar.gz && \
    mv geckodriver /usr/local/bin && rm -f /tmp/geckodriver.tar.gz
}

install_gecko

# enter a shell as www-data and run a command
exec su -s /bin/bash www-data -c "python3 /usr/src/app/app.py $FLAG"
tail -f /dev/null # ensures the docker doesnt stop prematurely