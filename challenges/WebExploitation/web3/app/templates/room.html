<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Basic Chatroom</title>
        <!-- Bootstrap CSS -->
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

        <style>
            .chat-container {
                height: 400px;
                overflow-y: scroll;
                border: 1px solid #ccc;
                padding: 10px;
            }

            .chat-message {
                margin-bottom: 10px;
            }
            .chat-message #hidden_action {
                display: none;
            }
            .chat-message:hover #hidden_action {
                display: inline;
            }

            .chat-input {
                width: 100%;
            }

        </style>
    </head>

    <body>
        <div class="container mt-5">
            <h2 class="text-center">Chatroom</h2>

            <div id="chatContainer" class="chat-container">
            </div>

            <form id="messageForm" class="mt-3">
                <div class="form-group">
                    <input type="text" class="form-control chat-input" id="messageInput" placeholder="Type a message..."
                        required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">Send</button>
            </form>
        </div>

        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

        <script>
            // Function to fetch messages from the backend
            function fetchMessages() {
                $.get('/get_messages', function(data) {
                    const chatContainer = $('#chatContainer');
                    chatContainer.empty();  // Clear existing messages

                    // Append new messages
                    data.messages.forEach(function(message) {
                        // Create the message div
                        const messageDiv = document.createElement('div');
                        messageDiv.classList.add('chat-message');

                        // Create the user span and append to messageDiv
                        const userSpan = document.createElement('strong');
                        userSpan.textContent = `${message.user}:`;
                        messageDiv.appendChild(userSpan);

                        // Create the message span and append to messageDiv
                        const messageSpan = document.createElement('span');
                        messageSpan.textContent = ` ${message.message}    `;
                        messageDiv.appendChild(messageSpan);

                        // Create the report link and append to messageDiv
                        const reportLink = document.createElement('a');
                        reportLink.id = 'hidden_action';
                        reportLink.href = `/report?message_id=${Math.floor(Math.random() * 1000000)}&message_sender=${message.user}`;
                        reportLink.textContent = 'REPORT';
                        messageDiv.appendChild(reportLink);

                        // Append the messageDiv to the chat container
                        chatContainer.append(messageDiv);
                    });

                    // Scroll to the bottom of the chat
                    chatContainer.scrollTop(chatContainer[0].scrollHeight);
                });
            }
        
            // Fetch new messages every 2 seconds
            setInterval(fetchMessages, 4000);
        
            // Handle the message form submission
            $('#messageForm').submit(function(event) {
                event.preventDefault();  // Prevent default form submission
                const messageInput = $('#messageInput').val();  // Get the message from the input field
                if (messageInput) {
                    // Send the message via a POST request using fetch
                    fetch('/send_message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded', // Or 'application/json' depending on your Flask route handling
                        },
                        body: new URLSearchParams({
                            'message': messageInput  // Send the message as form data
                        })
                    })
                    .then(response => response.text())  // Process response as text (or JSON if you return JSON)
                    .then(data => {
                        console.log(data);  // Log the success response from the server
                        $('#messageInput').val('');  // Clear the input field
                        fetchMessages();  // Optionally, refresh chat messages after sending
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);  // Handle any error
                    });
                }
            });
        </script>
    </body>
</html>