// ES Format Inclusions
import { fileURLToPath } from "url";
import express from "express";
import path from "path";
import fs from "fs";

const app = express();
const port = 4444; // change to desired port

// Get the correct directory of the current script
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Allows data to be sent from POST requests
app.use(express.urlencoded({ extended: true }));


const companies = [
    { name: "Apple", ceo: "Tim Cook", address: "Cupertino, CA" },
    { name: "Google", ceo: "Sundar Pichai", address: "Mountain View, CA" },
    { name: "Microsoft", ceo: "Satya Nadella", address: "Redmond, WA" },
    { name: "Amazon", ceo: "Andy Jassy", address: "Seattle, WA" },
    { name: "Meta", ceo: "Mark Zuckerberg", address: "Menlo Park, CA" },
    { name: "Tesla", ceo: "Elon Musk", address: "Palo Alto, CA" },
    { name: "Netflix", ceo: "Ted Sarandos", address: "Los Gatos, CA" },
    { name: "IBM", ceo: "Arvind Krishna", address: "Armonk, NY" },
    { name: "Intel", ceo: "Pat Gelsinger", address: "Santa Clara, CA" },
    { name: "NVIDIA", ceo: "Jensen Huang", address: "Santa Clara, CA" },
    { name: "Adobe", ceo: "Shantanu Narayen", address: "San Jose, CA" },
    { name: "Oracle", ceo: "Safra Catz", address: "Austin, TX" },
    { name: "Uber", ceo: "Dara Khosrowshahi", address: "San Francisco, CA" },
    { name: "Salesforce", ceo: "Marc Benioff", address: "San Francisco, CA" },
    { name: "Snapchat", ceo: "Evan Spiegel", address: "Santa Monica, CA" },
    { name: "Spotify", ceo: "Daniel Ek", address: "Stockholm, Sweden" },
    { name: "Twitter (X)", ceo: "Linda Yaccarino", address: "San Francisco, CA" },
    { name: "Cisco", ceo: "Chuck Robbins", address: "San Jose, CA" },
    { name: "HP", ceo: "Enrique Lores", address: "Palo Alto, CA" },
    { name: "Dell", ceo: "Michael Dell", address: "Round Rock, TX" }
];

app.get("/robots.txt", (req, res) => {
    res.type("text/plain");
    res.send("User-agent: *\nDisallow: /");
});

app.get('/.htaccess', (req, res) => {
    try {
        const ip = req.ip;
        if (ip !== "127.0.0.1" && ip !== "::1") {
            return res.status(403).send("Forbidden");
        }
    
        // Set the content type to plain text
        res.setHeader('Content-Type', 'text/plain');
        // Send the contents of the file
        fs.createReadStream(path.join(__dirname, "htaccess")).pipe(res);
    } catch (err) {
        console.error(err);
        res.status(500).send("Server Error");
    }
});

app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, "index.html"));
});

app.post('/', (req, res) => {
    const searchName = req.body.name
    const filteredCompanies = companies.filter(company =>
        company.name.toLowerCase().includes(searchName) // Filter based on company name
    );

    // unsanitized user input allows for XSS (need to make constructed HTML prettier)
    res.send(`
        <h1>Search Results</h1>
        <h3>Company: ${searchName}</h3>
        ${filteredCompanies.map((company, index) => `
            <p># ${index + 10010}</p>
            <p>CEO: ${company.ceo}</p>
            <p>Address: ${company.address}</p>
        `).join('')}
    `);
});

// listen on all interfaces for networking reasons
app.listen(port, '0.0.0.0', () => {
    console.log(`Site running on http://0.0.0.0:${port}`);
});