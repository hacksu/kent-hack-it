// ES Format Inclusions
import { fileURLToPath } from "url";
import express from "express";
import path from "path";
import fs from "fs";

const app = express();
const port = 4445; // change to desired port

// Get the correct directory of the current script
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Allows data to be sent from POST requests
app.use(express.urlencoded({ extended: true }));


const companies = [
    { name: "Apple", ceo: "Tim Cook", address: "Cupertino, CA" },
    { name: "Google", ceo: "Sundar Pichai", address: "Mountain View, CA" },
    { name: "Microsoft", ceo: "Satya Nadella", address: "Redmond, WA" },
    { name: "Amazon", ceo: "Andy Jassy", address: "Seattle, WA" },
    { name: "Meta", ceo: "Mark Zuckerberg", address: "Menlo Park, CA" },
    { name: "Tesla", ceo: "Elon Musk", address: "Palo Alto, CA" },
    { name: "Netflix", ceo: "Ted Sarandos", address: "Los Gatos, CA" },
    { name: "IBM", ceo: "Arvind Krishna", address: "Armonk, NY" },
    { name: "Intel", ceo: "Pat Gelsinger", address: "Santa Clara, CA" },
    { name: "NVIDIA", ceo: "Jensen Huang", address: "Santa Clara, CA" },
    { name: "Adobe", ceo: "Shantanu Narayen", address: "San Jose, CA" },
    { name: "Oracle", ceo: "Safra Catz", address: "Austin, TX" },
    { name: "Uber", ceo: "Dara Khosrowshahi", address: "San Francisco, CA" },
    { name: "Salesforce", ceo: "Marc Benioff", address: "San Francisco, CA" },
    { name: "Snapchat", ceo: "Evan Spiegel", address: "Santa Monica, CA" },
    { name: "Spotify", ceo: "Daniel Ek", address: "Stockholm, Sweden" },
    { name: "Twitter (X)", ceo: "Linda Yaccarino", address: "San Francisco, CA" },
    { name: "Cisco", ceo: "Chuck Robbins", address: "San Jose, CA" },
    { name: "HP", ceo: "Enrique Lores", address: "Palo Alto, CA" },
    { name: "Dell", ceo: "Michael Dell", address: "Round Rock, TX" }
];

app.get("/robots.txt", (req, res) => {
    try {
        res.type("text/plain");
        res.send("User-agent: *\nDisallow: /");
    } catch (err) {
        console.error("Error Occured");
        res.status(500).send("Server Error");
    }
});

app.get('/.htaccess', (req, res) => {
    try {
        res.status(403).send("Forbidden");
    } catch (err) {
        console.error("Error Occured");
        res.status(500).send("Server Error");
    }
});

app.get('/.htpasswd', (req, res) => {
    try {
        res.setHeader('Content-Type', 'text/plain');
        res.send(`# ${process.env.FLAG}
    web_root:YmFzZTY0IGRlY29kZXI`); // fun message for those with keen-eyes
    } catch (err) {
        console.error("Error Occured");
        res.status(500).send("Server Error");
    }
});

app.get('/', (req, res) => {
    try {
        console.log("Requesting index.html");
        res.sendFile(path.join(__dirname, "index.html"));
    } catch (err) {
        console.error("Error Occured");
        res.status(500).send("Server Error");
    }
});

app.post('/', (req, res) => {
    try {
        console.log("Requesting Company Search");

        const searchName = req.body.name;
        const filteredCompanies = companies.filter(company =>
            company.name.toLowerCase().includes(searchName) // Filter based on company name
        );
    
        // local XSS - doesnt affect other players/users (smoke screen)
        res.send(`
            <h1>Search Results</h1>
            <h3>Company: ${searchName}</h3>
            ${filteredCompanies.map((company, index) => `
                <p># ${index + 10010}</p>
                <p>CEO: ${company.ceo}</p>
                <p>Address: ${company.address}</p>
            `).join('')}
        `);
    } catch (err) {
        console.error("Error Occured");
        res.status(500).send("Server Error");
    }
});

// listen on all interfaces for networking reasons
app.listen(port, '0.0.0.0', () => {
    console.log(`Site running on http://0.0.0.0:${port}`);
});