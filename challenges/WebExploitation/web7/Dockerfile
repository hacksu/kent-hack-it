# Use a lightweight PHP image
FROM php:8.2-cli

# Install cron and other deps
RUN apt-get update && apt-get install -y \
    cron \
    acl \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /var/www/html/app
RUN mkdir -p /var/www/html/app/db /var/www/html/app/uploads

# Copy app code
COPY app/*.php ./
COPY app/images/ ./images/

# Copy cleanup cron config
COPY cleanup-cron /etc/cron.d/cleanup-cron

# Fix permissions for cron
RUN chmod 0644 /etc/cron.d/cleanup-cron \
    && crontab /etc/cron.d/cleanup-cron

# Ensure app dir belongs to www-data
RUN chown -R www-data:www-data /var/www/html/

# Expose PHP port
EXPOSE 8080

# Entrypoint script to start cron as root, PHP as www-data
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

CMD ["/entrypoint.sh"]