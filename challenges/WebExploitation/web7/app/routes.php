<?php
// serve normal files (CSS, JS, etc)
if (php_sapi_name() === 'cli-server') {
    $url = parse_url($_SERVER["REQUEST_URI"], PHP_URL_PATH);
    $file = __DIR__ . $url;
    if (is_file($file)) {
        return false;
    }
}

// Clean the database every 5 minutes
$timestampFile = __DIR__ . '/.last_reset_time';
$now = time();
$shouldReset = false;

if (!file_exists($timestampFile)) {
    $shouldReset = true;
} else {
    $lastReset = (int)file_get_contents($timestampFile);
    if (($now - $lastReset) >= 300) { // 300 seconds = 5 minutes
        $shouldReset = true;
    }
}

if ($shouldReset) {
    $db = new PDO('sqlite:' . __DIR__ . '/db/blog.db');
    $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    $db->exec("DELETE FROM posts");
    file_put_contents($timestampFile, $now);

    require_once "init_db.php";
}

// send the route to index.php
require_once __DIR__ . '/index.php';
?>