<?php
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

require_once "auth.php";

// Only allow authenticated admins
if (empty($_SESSION['authenticated']) || $_SESSION['authenticated'] !== true) {
    header("Location: /login");
    exit;
}
if (!isset($_COOKIE['jwt']) || !($userData = verifyJWT($_COOKIE['jwt'], JWT_SECRET)) || $userData['isadmin'] !== 'true') {
    header("Location: /login");
    exit;
}

$uploadDir = __DIR__ . "/uploads";
if (!is_dir($uploadDir)) {
    mkdir($uploadDir, 0775, true);
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['file'])) {
    $file = $_FILES['file'];
    if ($file['error'] === UPLOAD_ERR_OK) {
        $filename = basename($file['name']);
        $target = $uploadDir . "/" . $filename;

        if (move_uploaded_file($file['tmp_name'], $target)) {
            header("Location: admin.php");
            exit;
        } else {
            echo "Failed to move uploaded file.";
        }
    } else {
        echo "File upload error.";
    }
}