<?php
session_start();

const JWT_SECRET = 'Ultr4_5uP3r_UnCr4cked_&_Sup3r_$ecret_UnHackableX0XO';

function base64UrlEncode($data) {
    return rtrim(strtr(base64_encode($data), '+/', '-_'), '=');
}

function base64UrlDecode($data) {
    return base64_decode(strtr($data, '-_', '+/'));
}

function createJWT(array $payload, int $expireSeconds = 3600): string {
    $header = ['alg' => 'HS256', 'typ' => 'JWT'];
    $payload['exp'] = time() + $expireSeconds;

    $base64UrlHeader = base64UrlEncode(json_encode($header));
    $base64UrlPayload = base64UrlEncode(json_encode($payload));
    $signature = hash_hmac('sha256', "$base64UrlHeader.$base64UrlPayload", JWT_SECRET, true);
    $base64UrlSignature = base64UrlEncode($signature);

    return "$base64UrlHeader.$base64UrlPayload.$base64UrlSignature";
}

function verifyJWT(string $jwt): ?array {
    $parts = explode('.', $jwt);
    if (count($parts) !== 3) return null;

    [$header, $payload, $signature] = $parts;
    $validSig = base64UrlEncode(hash_hmac('sha256', "$header.$payload", JWT_SECRET, true));
    if (!hash_equals($validSig, $signature)) return null;

    $payloadData = json_decode(base64UrlDecode($payload), true);
    if (!$payloadData || ($payloadData['exp'] ?? 0) < time()) return null;

    return $payloadData;
}

function setJWTCookie(string $jwt, int $expireSeconds = 3600): void {
    setcookie(
        'jwt',  // Cookie name
        $jwt,   // Cookie value
        [
            'expires' => time() + $expireSeconds,
            'path' => '/',
            'secure' => false,
            'httponly' => true,  // Attempt to prevent XSS JS access
            'samesite' => 'Strict'
        ]
    );
}
?>