<?php
require_once "auth.php";

$db = new PDO('sqlite:db/blog.db');
$db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_COOKIE['jwt'])) {
        $jwt = $_COOKIE['jwt'];  // Retrieve the JWT from the cookie
    
        // Your JWT verification function
        $userData = verifyJWT($jwt);

        // Cant trick us!
        if ($userData === null || ($userData['username'] !== $_SESSION['username'])) {
            header("Location: /logout");
            exit;
        }

        $title = trim($_POST['title'] ?? '');
        $content = trim($_POST['content'] ?? '');
    
        if ($title !== '' && $content !== '') {
            $stmt = $db->prepare("INSERT INTO posts (author, title, content, created_at) VALUES (:author, :title, :content, datetime('now'))");
            $stmt->bindParam(':author', $_SESSION['username']);
            $stmt->bindParam(':title', $title);
            $stmt->bindParam(':content', $content);
            $stmt->execute();
        }
    } else {
        header("Location: /logout");
        exit;
    }
}

header("Location: /");
exit;
?>