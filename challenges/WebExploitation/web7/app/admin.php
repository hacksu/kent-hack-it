<?php
// Start session safely
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

require_once "auth.php";

// Require login
if (empty($_SESSION['authenticated']) || $_SESSION['authenticated'] !== true) {
    $_SESSION['authenticated'] = false;
    $_SESSION['username'] = "";
    header("Location: /login");
    exit;
}

// Validate JWT (using cookie for consistency)
if (isset($_COOKIE['jwt'])) {
    $userData = verifyJWT($_COOKIE['jwt'], JWT_SECRET);
    if (!$userData || $userData['isadmin'] !== 'true') {
        // Not an admin
        $_SESSION['authenticated'] = false;
        $_SESSION['username'] = "";
        header("Location: /login");
        exit;
    }
} else {
    header("Location: /login");
    exit;
}

// Load uploaded files list
$uploadDir = __DIR__ . "/uploads";
$files = [];
if (is_dir($uploadDir)) {
    foreach (scandir($uploadDir) as $f) {
        if ($f !== "." && $f !== "..") {
            $files[] = $f;
        }
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .mode-controls { position: fixed; top: 15px; right: 15px; z-index: 10; display: flex; gap: 20px; }
    .user-info { position: fixed; top: 15px; left: 15px; z-index: 20; background-color: rgba(255,255,255,0.8); padding: 6px 12px; border-radius: 6px; }
    .dark-mode .user-info { background-color: rgba(33,37,41,0.8); color: #f8f9fa; }
    body { transition: background-color 0.3s ease, color 0.3s ease; }
    .dark-mode { background-color: #212529; color: #f8f9fa; }
    .light-mode { background-color: #f8f9fa; color: #212529; }
    .admin-box { background-color: #fff; padding: 2rem; border-radius: 1rem; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1); }
    .dark-mode .admin-box { background-color: #343a40; color: #f8f9fa; }
  </style>
</head>
<body id="body" class="light-mode">

  <!-- Top-left user info -->
  <div class="user-info">
    <h6 class="mb-0">Logged in as: <?= htmlspecialchars($_SESSION['username']) ?> (Admin)</h6>
  </div>

  <!-- Top-right mode and logout controls -->
  <div class="mode-controls">
    <a href="logout.php" class="btn btn-outline-secondary">Logout</a>
    <button id="mode-toggle" class="btn btn-outline-primary">ðŸŒ™</button>
  </div>

  <div class="container py-5">
    <div class="admin-box">
      <h2 class="mb-4">ðŸ“‚ File Upload Manager</h2>

      <!-- File Upload Form -->
      <form action="upload.php" method="POST" enctype="multipart/form-data" class="mb-4">
        <div class="mb-3">
          <label for="file" class="form-label">Choose file to upload</label>
          <input type="file" name="file" id="file" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-success">Upload</button>
      </form>

      <!-- Uploaded Files Table -->
      <h4>Available Files</h4>
      <?php if (count($files) === 0): ?>
        <p class="text-muted">No files uploaded yet.</p>
      <?php else: ?>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Filename</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody>
            <?php foreach ($files as $f): ?>
              <tr>
                <td><?= htmlspecialchars($f) ?></td>
                <td><a href="/uploads/<?= urlencode($f) ?>" target="_blank">View</a></td>
              </tr>
            <?php endforeach; ?>
          </tbody>
        </table>
      <?php endif; ?>
    </div>
  </div>

  <script>
    const savedTheme = sessionStorage.getItem('theme');
    if (savedTheme) {
      document.body.classList.remove('light-mode', 'dark-mode');
      document.body.classList.add(savedTheme);
    }

    const toggleButton = document.getElementById('mode-toggle');
    toggleButton.textContent = document.body.classList.contains('light-mode') ? 'ðŸŒ™' : 'ðŸŒž';

    toggleButton.addEventListener('click', () => {
      if (document.body.classList.contains('light-mode')) {
        document.body.classList.replace('light-mode', 'dark-mode');
        toggleButton.textContent = 'ðŸŒž';
        sessionStorage.setItem('theme', 'dark-mode');
      } else {
        document.body.classList.replace('dark-mode', 'light-mode');
        toggleButton.textContent = 'ðŸŒ™';
        sessionStorage.setItem('theme', 'light-mode');
      }
    });
  </script>
</body>
</html>